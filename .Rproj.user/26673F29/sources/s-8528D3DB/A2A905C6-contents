#' Calculate subjects' ddd in a period
#'
#' @import dplyr
#' @import data.table
#' @param case data.frame include subjects' id, dispensing date, drug ATC code, daily dosage, duration
#' @param index_day observation day
#' @param expo_range_before days before observation day
#' @param expo_range_after days after observation day
#' @param idColName a colum for subject's id
#' @param DispensingColName a colum for dispensing
#' @param SupplyDayColName a colum for supply day
#' @param DailyDosageColName a colum for daily dosage
#' @export

calDDDs.range <- function(case,
                          index_day,
                          expo_range_before = 36000,
                          expo_range_after = 36000,
                          idColName = patient_id,
                          DispensingColName = Dispensing,
                          SupplyDayColName = duration,
                          DailyDosageColName = Daily_dosage){

  colnames(case)[colnames(case)==deparse(substitute(idColName))] <- "patient_id"
  colnames(case)[colnames(case)==deparse(substitute(DispensingColName))] <- "Dispensing"
  colnames(case)[colnames(case)==deparse(substitute(SupplyDayColName))] <- "duration"
  colnames(case)[colnames(case)==deparse(substitute(DailyDosageColName))] <- "Daily_dosage"

  index_day <- as.Date(gsub("\\s+", "", deparse(substitute(index_day))))
  case <- get.ddd(case)
  case <- arrange(case, patient_id, Dispensing)
  case <- data.table(case)
  case[, star_day := index_day-expo_range_before]
  case[, index_day := index_day]
  case[, end_day := index_day+expo_range_after]
  case[, Daily_dosage2 := as.numeric(as.character(strsplit(case$Daily_dosage, "mg")))]
  case[, DDD_perday := round(Daily_dosage2/DDD, 2)]

  #DDDs before index
  case[, date3 := as.numeric(star_day-Dispensing)]
  case[, date4 := as.numeric(index_day-Dispensing)]
  case[, DDDs_before := if_else(date3<0,
                         if_else(date4>duration,
                                 duration*DDD_perday,
                                 if_else(date4>0,
                                         (duration-date4)*DDD_perday,
                                 0)),
                         if_else(date3>duration,
                                 0,
                                 (duration-date3)*DDD_perday)),
       by = patient_id]
  case_before <- case[, sum(DDDs_before), by = patient_id]
  colnames(case_before)[colnames(case_before)=="V1"] <- paste0("DDDs_before_",expo_range_before,"_days")

  #DDDs after index
  case[, date3_ := as.numeric(end_day-Dispensing)]
  case[, date4_ := as.numeric(Dispensing-index_day)]
  case[, date5 := as.numeric((Dispensing+duration)-index_day)]
  case[, DDDs_after := if_else(date3_>0,
                                if_else(date4_>0,
                                        if_else(date3_>duration,
                                                duration*DDD_perday,
                                                date3_*DDD_perday),
                                                if_else(date5>0,
                                                        (duration-abs(date4_)*DDD_perday),
                                                        0)),
                                0),
       by = patient_id]
  case_after <- case[, sum(DDDs_after), by = patient_id]
  colnames(case_after)[colnames(case_after)=="V1"] <- paste0("DDDs_after_",expo_range_after,"_days")

  case <- case %>% select(patient_id, star_day, index_day, end_day, DDDs_before, DDDs_after)
  case_bf_af <- inner_join(case_before,case_after)
  case_temp <- case %>% select(patient_id, star_day, index_day, end_day)
  case <- inner_join(case_temp,case_bf_af)
  case <- unique(case)
  colnames(case)[colnames(case)== "patient_id"] <- deparse(substitute(idColName))
  return(case)

}


